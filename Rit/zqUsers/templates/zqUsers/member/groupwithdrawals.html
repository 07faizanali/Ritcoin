{% extends 'zqUsers/member/layout/main.html' %}

{% load static %}
{% load customFilters %}
{% block 'addHeaderScripts' %}

{% comment %} <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous"> {% endcomment %}

<style>
      @media (min-width: 576px) {
        .tabs {
            height: 138vh !important;
          
          }
       
     }

     (max-width: 360px) {
      #tb{
        overflow-y:auto !important;
       } 
       .table-responsive{
        overflow-y:auto !important;
        max-height : 230px !important;
       }
     }
    
.tabs {
  display: flex;
  box-sizing: border-box;
  flex-direction: column;
  padding: 1rem;
  height: 125dvh;

  z-index:1;
}
.tabs .tabs-nav {
  display: flex;
  width: max-content;
  margin: 0 auto;
  padding: 5px;
  gap: 5px;
  border-radius: 9999px;
  background-color: #efefef;
  box-shadow: 2px 2px 10px #3333;
}
.tabs .tab-nav {
  display: block;
  outline: none;
  border: 2px solid rgb(0,34,51);
  color: rgb(0,34,51);
  border-radius: 9999px;
  padding: 0.5em 2em;
  font-weight: 700;
  cursor: pointer;
  background-color: inherit;
  transition: background-color 300ms, color 300ms;
}
.tabs .tab-nav:hover {
  background-color: rgb(0,34,51);
  color: #fff;
}
.tabs .tab-content input[name="tab-index"] {
  display: none !important;
}
.tabs .tab-contents {
    display: block;
    position: relative;
    height: 100%;
    margin-top: 1rem;
    background-color: inherit;
    overflow: hidden;
    z-index: 1;
}
 .tabs .tab-content {
  background-color: inherit;
  display: block;
  position: absolute;
  width: 100%;
  height: 100%;
  max-height: 100%;
  top: 0; left: 100%;
  overflow: hidden;
  box-sizing: border-box;
  border-radius: 10px;
  padding: 0;
} 
.tabs.animate .tab-content {
  transition: left 500ms;
}
.tabs .tab-content .content {
  max-height: 100%;
  max-width: 100%;
 
}

.tabs .tab-content:has(input[name="tab-index"]:checked) {
  left: 0;
  z-index: 100;
}

        .dropdown-icon::after {
            content: "\f078"; /* Font Awesome caret down icon */
            font-family: "Font Awesome 5 Free";
            font-weight: 900;
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
        }

</style>

 <style>
        .card.disabled {
            opacity: 0.6;
            cursor: not-allowed;
            pointer-events: none;
            filter: grayscale(100%);
        }
    </style>


    <style>
        #connectWalletButton.disabled {
          background-color: green;
          cursor: not-allowed;
        }
      </style>
{% endblock %}


{% block 'content' %}

<div class="container-fluid">

    <div class="row">
        <div class="col-xl-12">
        <div class="col-lg-4"><h3>Group Withdrawal</h3></div>
        <div>
    </div>
    <div  class="row">

        <div class="col-xl-12">
            {% comment %} <div  class="tabs"> {% endcomment %}
                {% comment %} <div class="tabs-nav">
                    <!--   Must be label element   -->
                    <label class="tab-nav" for="tab-index2">INR</label>
                    <label class="tab-nav" for="tab-index1">USDT</label> {% endcomment %}
                {% comment %} </div>       {% endcomment %}
           
            <div class="tab-contents">
                <div class="tab-content">
                    {% comment %} <input type="radio" name="tab-index" id="tab-index1" > {% endcomment %}
                    <div class="content">
                       
                    
                        <div class="row">
                        
                            <div class="col-lg-12">
                                <div class="card transaction-table">
                                    <div class="card-header border-0 flex-wrap pb-0">
                                        <div class="mb-2">
                                            <h4 class="card-title">Recent Withdrawals</h4>
                                            <p class="mb-sm-3 mb-0">All Withdrawals</p>
                                
                                        </div>
                                    </div>
                        
                                
                                    <div class="card-body p-0"style="overflow-x:auto !important;overflow-y:auto !important;" >
                                    
                                        <div class="table-responsive" style="overflow-y:auto !important;">
                                            <table class="table table-responsive-md">
                                                <thead>
                                                    <tr>
                                                        <th>
                                                            #
                                                        </th>
                                                        <th>Username</th>
                                                        
                                                        <th>Requested Amount($)</th>
                                                        <th>Requested Amount(&#8377;)</th>
                                                        <th>Admin charge(&#8377;)</th>
                                                        <th>Total Transferred(&#8377;)</th>
                                                        <th>Coin</th>
                                                        <th>Coin Rate(USDT)</th>
                                                        <th>Trasferred value($)</th>
                                                        <th>Transaction Hash</th>
                                                        <th>Date</th>
                                                        {% comment %} <th>To</th> {% endcomment %}
                                                        <th class="text-end">Status</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                
                                                    {% if allWdsINR %}
                
                                                    {% for index,inv in  allWdsINR %}
                
                
                                                    <tr>
                                                        <td>
                                                            <svg class="arrow style-2 svg-main-icon" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="24px" height="24px" viewBox="0 0 24 24" version="1.1">
                                                                <g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                                                                    <polygon points="0 0 24 0 24 24 0 24"/>
                                                                    <rect fill="#fff" opacity="0.3" transform="translate(11.646447, 12.853553) rotate(-315.000000) translate(-11.646447, -12.853553) " x="10.6464466" y="5.85355339" width="2" height="14" rx="1"/>
                                                                    <path d="M8.1109127,8.90380592 C7.55862795,8.90380592 7.1109127,8.45609067 7.1109127,7.90380592 C7.1109127,7.35152117 7.55862795,6.90380592 8.1109127,6.90380592 L16.5961941,6.90380592 C17.1315855,6.90380592 17.5719943,7.32548256 17.5952502,7.8603687 L17.9488036,15.9920967 C17.9727933,16.5438602 17.5449482,17.0106003 16.9931847,17.0345901 C16.4414212,17.0585798 15.974681,16.6307346 15.9506913,16.0789711 L15.6387276,8.90380592 L8.1109127,8.90380592 Z" fill="#fff" fill-rule="nonzero"/>
                                                                </g>
                                                            </svg>
                                                        </td>
                                                        <td>{{inv.memberid.username}}</td>
                                                        {% comment %} <td>{{inv.transactionId.hashtrxn}}</td> {% endcomment %}
                                                        <td>{{inv.amicoinin_doller}}$</td>
                                                        <td>{{inv.requested_amount}}</td>
                                                        <td class="text-danger font-w600">-{{inv.admin_charge}}</td>
                                                        <td class="text-success font-w600">+{{inv.total_value}}</td>
                                                        
                                                        <td> {{inv.transactionId.cointype}}</td>
                                                        <td><div class="d-flex align-items-center"><img src="images/svg/btc.svg" alt="" class="me-2 img-btc">{{inv.transactionId.coinvalue}}</div></td>
                                                        <td class="text-success font-w600">{{inv.transactionId.amivolume}}$</td>
                                                        
                                                        <td>{{inv.transactionId.hashtrxn}}</td>
                                                        <td class="font-w600">{{inv.transactionId.trxndate}}</td>
                                                        {% comment %} <td></td> {% endcomment %}
                                                        {% comment %} <td class="text-success font-w600">{{inv.amivolume}}</td> {% endcomment %}
                                                        <td  class="text-end"><div class="badge badge-sm badge-success">SUCCESS</div></td>
                                                    </tr>
                
                                                    {% endfor %}
                                                    {% endif %}
                
                                                
                
                
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>


                    </div>
                </div>



            </div>
        </div>

        </div>
    </div>


</div>    



{% endblock  %}



{% block 'addFooterScripts' %}
<script src="{% static 'dist/bundle.js' %}"></script>  <!-- Adjust path as needed -->

{% comment %} <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script> {% endcomment %}
{% comment %} <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.6.1-rc.0/web3.min.js"></script> {% endcomment %}
{% comment %} <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>  {% endcomment %}




<script type="text/javascript">


  
	


    let web3;
    let account;


    {% comment %} async function connectMetaMask() {
        if (typeof window.ethereum !== 'undefined') {
            web3 = new Web3(window.ethereum);
            await window.ethereum.request({ method: 'eth_requestAccounts' });
            const accounts = await web3.eth.getAccounts();
            account = accounts[0];
        
           // console.log(accounts);
            //document.getElementById('account').innerText = 'Connected Account: ' + account;
            //document.getElementById('connect-button').innerText = 'Connected';
            
            //document.getElementById('cnbtn').innerHTML = `<button type="button" id="connect-button" class="btn btn-success">Connected</button>`;
           
           // $('#walletAdd').val(account);
			$('#walletAdd').val(account).prop('readonly', true);
           // $('#walletAdd').setattr(account);
            //$('#metaAdd').val(account);
           // const chainId = await web3.eth.getChainId();
            //web3 = new Web3(window.ethereum);

            const chainId = await web3.eth.getChainId();
            let networkName;
            let nativeCurrency;

            switch (chainId) {
                case 1:
                    networkName = 'Ethereum Mainnet';
                    nativeCurrency = 'ETH';
                    break;
                case 56:
                    networkName = 'Binance Smart Chain Mainnet';
                    nativeCurrency = 'BNB';
                    break;
                case 97:
                    networkName = 'Binance Smart Chain Testnet';
                    nativeCurrency = 'tBNB';
                    break;
                default:
                    networkName = 'Unknown Network';
                    nativeCurrency = 'Unknown';
            }

            //document.getElementById('network').innerText = 'Connected Network: ' + networkName;

            if (chainId == 97) { // Check if the connected network is BSC Testnet

                var totalBal=await getBalance(account);
                if(totalBal){

                    document.getElementById('cnbtn').innerHTML = `
            <button type="button" class="btn btn-success"><i class="fas fa-wallet"></i>     ${totalBal}tBNB</button> `;
                }


            } 
            if (chainId !== 97) {
                try {
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: '0x61' }], // Chain ID 97 in hexadecimal (0x61)
                    });
                } catch (switchError) {
                    if (switchError.code === 4902) {
                        try {
                            await window.ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [
                                    {
                                        chainId: '0x61',
                                        chainName: 'BSC Testnet',
                                        rpcUrls: ['https://data-seed-prebsc-1-s1.binance.org:8545/'],
                                        nativeCurrency: {
                                            name: 'tBNB',
                                            symbol: 'tBNB',
                                            decimals: 18,
                                        },
                                        blockExplorerUrls: ['https://testnet.bscscan.com'],
                                    },
                                ],
                            });
                        } catch (addError) {
                            console.error(addError);
                        }
                    }
                }
            }

        } else {
            alert('MetaMask is not installed. Please install MetaMask to proceed.');
        }
    }
    async function getBalance(account) {
        try {
            const balance = await web3.eth.getBalance(account);
            const balanceInBNB = web3.utils.fromWei(balance, 'ether');

            return balanceInBNB
           // document.getElementById('balance').innerText = 'Balance: ' + balanceInBNB + ' tBNB';
        } catch (error) {
            console.error('Error getting balance:', error);
            return false
        }
    }
    async function payWithMetaMask() {

        var amnt=document.getElementById('amount').value

        const response = await fetch(`/member/get-busd-price/`);
        const data = await response.json();
        const priceInUsd = data.price;
        console.log(priceInUsd);
        const cryptoAmount = (amnt / priceInUsd).toFixed(18); // Calculate crypto amount for $55

        console.log(cryptoAmount);
        if (!account) {
            alert('Please connect to MetaMask first.');
            return;
        }

        web3.eth.sendTransaction({
            from: account,
            to: '0xe749438B8CEBC367869ADAAf7D1B108d3c77A856', // Replace with your testnet receiving address
            //value: web3.utils.toWei('1', 'ether') // Amount in tBNB
            

            value: web3.utils.toWei(cryptoAmount, 'ether') // Amount in tBNB
        })
        .on('transactionHash', function(hash) {
            console.log('Transaction Hash:', hash);
            sendTransactionHashToDjango(hash);
        }).on('error', console.error);
        /*.on('confirmation', function(hash,confirmationNumber, receipt) {
            console.log(hash);
            console.log('Confirmation Number:', confirmationNumber);
            console.log('Receipt:', receipt);
        })*/
        
    } {% endcomment %}

    {% comment %} function sendTransactionHashToDjango(transactionHash) {
        fetch('/member/verify-transaction/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ transactionHash: transactionHash })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Transaction verified and funds added to your wallet.');
                location.reload(); // Reload the page
            } else {
                alert('Transaction verification failed.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }
    {% endcomment %}
	 function sendOTPPhone() {



        
		const phone_num = document.getElementById('phNumber').value;
		const usrname = document.getElementById('usrname').value;
		//const totalBal=`{{request.user.totalWalletBalance}}`;
		//console.log(amount);
		if (!phone_num) {
			alert('Please enter a  valid phone number.');
			return;
		}
        const phoneRegex = /^\d{10}$/;
    
        if (!phoneRegex.test(phone_num)) {
            alert('Please enter a valid phone number.');
            return;
        }
	

        if(phone_num){

        bt = $(`#sendOTP`);
        bt.attr("disabled", "").html("<i class='fa fa-spin fa-spinner'></i>&nbsp;&nbsp;Please wait...");
        $('#phNumber').prop('readonly', true);
        $('#usrname').prop('readonly', true);
		fetch('/member/withdraw/', {
			method: 'POST',
			headers: {
				'Content-Type': 'application/json',
				'X-CSRFToken': getCookie('csrftoken')
			},
			body: JSON.stringify({ phone_number: phone_num, type: 'INR',full_name:usrname,what_for:'sendOTP' })
		})
		.then(response => response.json())
		.then(data => {
			if (data.status) {

                if (data.status && data.msg =='Already Registered' ){
                    alert("Phone number verified successfully");

				    location.reload();
                    return
                }

                $(`#entOTPMsgs`).html('enter otp sent to your phone number');
                $('#entPhoneOTPDiv').css('display', 'block');

                $('#sendOTP').css('display', 'none');
                $('#verifyPhone').css('display', 'block');
                //$('#ActivateId').css('display', 'block');
				//alert( data.msg);
			} else {
				alert(data.msg);

				location.reload();
			}
		})
		.catch(error => {
			console.error('Error:', error);
		});

     } 


	}
	 function verifyOTPPhone() {



        
		const phone_num = document.getElementById('phNumber').value;
		const usrname = document.getElementById('usrname').value;
        const OTP = document.getElementById('phoneOTP').value;

		//const totalBal=`{{request.user.totalWalletBalance}}`;
		//console.log(amount);
		if (!phone_num) {
			alert('Please enter a  valid phone number.');
			return;
		}
		if (!OTP) {
			alert('Please enter a  valid OTP.');
			return;
		}


        const phoneRegex = /^\d{10}$/;
    
        if (!phoneRegex.test(phone_num)) {
            alert('Please enter a valid phone number.');
            return;
        }
	

        if(phone_num && OTP ){

        bt = $(`#verifyPhone`);
        bt.attr("disabled", "").html("<i class='fa fa-spin fa-spinner'></i>&nbsp;&nbsp;Please wait...");
        $('#phNumber').prop('readonly', true);
        $('#usrname').prop('readonly', true);
        $('#phoneOTP').prop('readonly', true);
		fetch('/member/withdraw/', {
			method: 'POST',
			headers: {
				'Content-Type': 'application/json',
				'X-CSRFToken': getCookie('csrftoken')
			},
			body: JSON.stringify({ phone_number: phone_num, type: 'INR',full_name:usrname,'entOTP':OTP,what_for:'otpVerify' })
		})
		.then(response => response.json())
		.then(data => {
			if (data.status) {
                alert("OTP verified successfully");
                location.reload();
                //$('#ActivateId').css('display', 'block');
				//alert( data.msg);
			} else {
				alert(data.msg);

				location.reload();
			}
		})
		.catch(error => {
			console.error('Error:', error);
		});

     }


	}

    function addBank() {



        
		const acHolderName = document.getElementById('acHolderName').value;
		const bankName = document.getElementById('bankName').value;
        const ifscCode = document.getElementById('ifscCode').value;
        const acNumber = document.getElementById('acNumber').value;
        const confAcNumber = document.getElementById('confAcNumber').value;

		//const totalBal=`{{request.user.totalWalletBalance}}`;
		//console.log(amount);
		if (!acHolderName) {
			alert('Please enter account holder name.');
			return;
		}
		if (!bankName) {
			alert('Please enter Bank Name.');
			return;
		}
		if (!ifscCode) {
			alert('Please enter IFSC code.');
			return;
		}
		if (!acNumber) {
			alert('Please enter valid account number.');
			return;
		}
		if (!confAcNumber) {
			alert('Please enter valid confirm account number.');
			return;
		}

        if(acNumber.trim()!==confAcNumber.trim()){
            alert('Account number and confirm account number should be same.');
            return;

        }


      
	

        if (acHolderName && bankName && ifscCode && acNumber && confAcNumber){

            bt = $(`#addBankDetails`);
            bt.attr("disabled", "").html("<i class='fa fa-spin fa-spinner'></i>&nbsp;&nbsp;Please wait...");
            $('#acHolderName').prop('readonly', true);
            $('#bankName').prop('readonly', true);
            $('#ifscCode').prop('readonly', true);
            $('#acNumber').prop('readonly', true);
            $('#confAcNumber').prop('readonly', true);

            fetch('/member/withdraw/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ accountHolder: acHolderName, type: 'INR',BankName:bankName,IFSC:ifscCode,accountNumber:acNumber,confirmAccountNumber:confAcNumber,what_for:'addBankDetails' })
            })
            .then(response => response.json())
            .then(data => {

               console.log(data);
                if (data.status) {
                    
                    alert("Bank registred successfully");
                    location.reload();
                    //$('#ActivateId').css('display', 'block');
                    //alert( data.msg);
                } else {
                    alert(data.msg);

                    location.reload();
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });

        }


	}
    function withdrawFundINR() {



		const wdAMNT = document.getElementById('Wdamount').value;
		const bankSelected = document.getElementById('bankSelect').value;
         
        const avilableBalanceToWithdraw=parseFloat(`{{request.user.totalWithdrawalableBalance}}`)*90;
       console.log(wdAMNT);
        console.log(bankSelected);
        console.log(avilableBalanceToWithdraw);
        
		//const totalBal=`{{request.user.totalWalletBalance}}`;
		//console.log(totalBal);
		if (!wdAMNT) {
			alert('Please enter amount.');
			return;
		}
		if (parseFloat(wdAMNT)<20 ) {
			alert('Minimum withdrawal amount is 20');
			return;
		}
		if (parseFloat(wdAMNT)>5000 ) {
			alert('Maximum withdrawal limit is 5000');
			return;
		}

       if (parseFloat(wdAMNT)>parseFloat(avilableBalanceToWithdraw)){

        alert("You have Insufficient balance in your account to process this withdrawal");
        location.reload();
        return
       }



        if (parseFloat(wdAMNT)<=parseFloat(avilableBalanceToWithdraw)){

            bt = $(`#withdrawButtonINR`);
            bt.attr("disabled", "").html("<i class='fa fa-spin fa-spinner'></i>&nbsp;&nbsp;Please wait...");
           // $('#bankName').prop('readonly', true);
           $('#Wdamount').prop('readonly', true);
           $('#bankSelected').prop('disbaled', true);
           // $('#acNumber').prop('readonly', true);
           // $('#confAcNumber').prop('readonly', true);

            fetch('/member/withdraw/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ withdrawAmount: parseFloat(wdAMNT),selectedBank:bankSelected ,type: 'INR',what_for:'withdrawFund' })
            })
            .then(response => response.json())
            .then(data => {

              
                if (data.status) {
                    
                    alert(data.msg);
                    location.reload();
                   
                } else {
                    alert(data.msg);

                    location.reload();
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });

        }else{
            alert("You have Insufficient balance in your account to process this withdrawal");
            location.reload();
            return

        }


	}
	
	


	async function withdraw() {
		const amount = document.getElementById('amount').value;
		const account = document.getElementById('walletAdd').value;
		const totalBal=`{{request.user.totalWalletBalance}}`;

        console.log(amount,account,totalBal);

		//console.log(amount);
		if (!account) {
			alert('Please connect to wallet first.');
			return;
		}
		if (!amount) {
			alert('Please enter an amount.');
			return;
		}


		if (amount && parseFloat(amount)>parseFloat(totalBal)) {
			alert('Insufficient wallet balance');
			return;
		}

		if (amount && parseFloat(amount)<1) {
			alert('Minimun withdrawal amount is $10');
			return;
		}



		fetch('/member/withdraw/', {
			method: 'POST',
			headers: {
				'Content-Type': 'application/json',
				'X-CSRFToken': getCookie('csrftoken')
			},
			body: JSON.stringify({ account: account, amount: amount,type:'USD' })
		})
		.then(response => response.json())
		.then(data => {
			if (data.success) {
				location.reload();
				alert('Withdrawal successful! Transaction Hash: ' + data.transactionHash);
			} else {
				location.reload();
				alert('Withdrawal failed: ' + data.error);
			}
		})
		.catch(error => {
			console.error('Error:', error);
		});


	}


    {% comment %} } {% endcomment %}



	//document.getElementById('connectButton').onclick = connectMetaMask;
	document.getElementById('withdrawButton').onclick = withdraw;
	document.getElementById('verifyPhone').onclick = verifyPhoneNumber;
	document.getElementById('sendOTP').onclick = sendOTPPhone; 
	 document.getElementById('addBankDetails').onclick = addBank; 


    {% comment %} document.getElementById('connect-button').addEventListener('click', connectMetaMask); {% endcomment %}
    {% comment %} document.getElementById('pay-button').addEventListener('click', payWithMetaMask); {% endcomment %}
    document.getElementById('verifyPhone').addEventListener('click', verifyPhoneNumber);
    document.getElementById('sendOTP').addEventListener('click', sendOTPPhone);
</script>


{% endblock %}




